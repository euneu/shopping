<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/shopping.css">
    <title>Document</title>
</head>
<body class = "">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">집꾸미기</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">스토어</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">시공견적</a>
              </li>
            </ul>
          </div>
        </div>
    </nav>
    
    <div class="modal1">
      <div class="white-bg">
        <form>
          <div class="my-3">
            <h3>성함</h3>
            <input type="text" class="form-control" id="user_name">
           </div>
           <div class="my-3">
            <h3>연락처</h3>
             <input type="text" class="form-control" id="user_phone">
           </div>
           <button type="button" class="btn btn-dark" id="receipt">입력완료</button>
           <button type="button" class="btn btn-danger" id="close">닫기</button>
        </form> 
      </div>
    </div> 

    <div class="modal2">
      <div class="white-bg">
        <h4>영수증</h4>
        <canvas id="canvas" width="350" height="850"></canvas>
        <div>
          <button id="receipt_close">닫기</button>
        </div>
      </div>
    </div>

    <div class="m-4">
        <div>
            <form id = "form">
                <input id ="search" type="text" placeholder="검색어 입력">
            </form>
        </div>
        <div class="produts-item row mt-4 mx-2">
            
        </div>
    </div>
    <div class="cart p-3">
        <p>장바구니</p>
        <div class="row drag">
            <p>여기로 드래그</p>

        </div>
    </div>
    <div class="m-3">
      <h5>최종가격</h5>
      <p class="final_price">가격 : </p>
      <button class="btn btn-dark buy">구매하기</button>

    </div>
    <script>

      
      let cart = [] // 장바구니에 들어갈 상품들
      
      $.get('/store.json').done(function(data){
        let products = data.products

        //-----상품 불러오기-----//
        products.forEach(function(a) {
          $('.produts-item').append(`
            <div class="col-sm-3">
                    <div class="item rounded p-2 bg-light" draggable="true" data-id="${a.id}">
                        <img src="/img/${a.photo}" draggable="false" class="w-100">
                        <h5 class="card-title">${a.title}</h5>
                        <p class="card-text"><small class="text-muted">${a.brand}</small></p>
                        <p class="card-text">가격 : ${a.price}</p>
                        <button class="btn btn-dark add" data-id="${a.id}">담기</button>
                    </div>
                  </div>
            `);
        });


        //------상품검색--------//
        $('#form').on("input", function(e){
          var input = $('#search').val();

          console.log(input)
          
          var search_arr = products.filter(function(item){
            return item.title.includes(input)
          })
          $('.row').html('');
          search_arr.forEach(function(a) {
          $('.produts-item').append(`
            <div class="col-sm-3">
                    <div class="item rounded p-2 bg-light" draggable="true" data-id="${a.id}">
                        <img src="/img/${a.photo}" draggable="false" class="w-100">
                        <h5 class="card-title">${a.title}</h5>
                        <p class="card-text"><small class="text-muted">${a.brand}</small></p>
                        <p class="card-text">가격 : ${a.price}</p>
                        <button class="btn btn-dark add" data-id="${a.id}">담기</button>
                    </div>
                  </div>
            `);
        });
        })


        //-----담기 버튼-----//
        
        $('.add').click(function(e){
          //장바구니에 상품 추가
          //대신 장바구니에 상품이 있다면 숫자만 추가

          //이벤트가 발생한 대상의 데이터 값
          //지금 누른 상품 번호
          let item_id = e.target.dataset.id;
          
          //장바구니 창에 상품이 존재하는가?
          //findIndex - > 첫 번째 요소의 인덱스 값을 반환 없다면 -1 반환
          var cart_item_id = cart.findIndex(function(a){
            return item_id == a.id
          })

          //cart_item == -1 라면 장바구니에 상품이 존재하지 않았다는 의미
          //cart에 추가해줌
          //find() -> 첫 번째 요소 값을 반환
          if(cart_item_id == -1){
            //첫 번째 요소 값 반환하기 위함(products의 상품 정보 가져오려고)
            let present_item =products.find(function(a){
              return a.id == item_id
            })
            //cart에 추가해줌
            //count는 장바구니에 추가한 갯수임
            present_item.count = 1;
            cart.push(present_item)
          }
          else{
            cart[cart_item_id].count++;
           }

          
          $('.drag').html('');
          cart.forEach(function(a) {
            $('.drag').append(
              `<div class="col-sm-3">
                      <div class="rounded p-2 bg-light" draggable="true">
                          <img src="/img/${a.photo}" class="w-100">
                          <h5 class="card-title">${a.title}</h5>
                          <p class="card-text"><small class="text-muted">${a.brand}</small></p>
                          <p class="card-text text-dark ">가격 : </p>
                          <p class="text-dark">${a.price}</p>
                          <input type="number" value="${a.count}" class="item-count w-100">
                      </div>
                    </div>
              `);
          });

          calculation();

          //---input 값 조정해도 계산되도록---//
          $('.item-count').on('input',function(){
            calculation();
          })
        }); //담기 끗!

        console.log(cart)
        
        //----드래그엔드롭-----//
          $('.item').on('dragstart', function(e){
            e.originalEvent.dataTransfer.setData('id',e.target.dataset.id)
          });
          $('.drag').on('dragover', function(e){
            e.preventDefault();
          });

          $('.drag').on('drop', function(e){

            let drag_item = e.originalEvent.dataTransfer.getData('id');
            $('.add').eq(drag_item).click();
            console.log(drag_item);

          });

      }); //get 끝


      //---최종가격---//

      //장바구니 input 안의 개수가 달라질 때마다 가격을 바꾸면 됨

      function calculation() {
        let final_price = 0;
        

        for(var i = 0; i< $('.item-count').length; i++){
          var count = $('.item-count').eq(i).val();
          var price = $('.item-count').eq(i).siblings('p').eq(2).text();
          
          final_price += parseFloat(count*price);

        }
        console.log(final_price)
        $('.final_price').html(`가격 : ${final_price}`);
      }

      //----구매하기, 영수증 클릭하면 열고 닫기----///
      $('.buy').on('click',function(){
        $('.modal1').addClass('show-modal');
      });
      $('#close').on('click',function(){
        $('.modal1').removeClass('show-modal');
      });

      
      //---성함, 연락처 저장---//

      let user_name = '';
      let user_phone = '';

      $('#user_name').on('input',function(){
        user_name = $('#user_name').val();
      })
      $('#user_name').on('input',function(){
        user_phone  = $('#user_phone').val();
      })

      $('#receipt').on('click',function(){
        $('.modal2').addClass('show-modal');
        var canvas = document.getElementById('canvas'); 
        var c = canvas.getContext('2d');
        c.font = '20px dotum';
        c.fillText(`성함 : ${user_name}`,20,30);
        c.fillText(`연락처 : ${user_phone}`,20,40);
        let sum = 0;
        cart.forEach(function(a,i){
          sum += parseInt(a.count)
          var count = (i+1);
          c.fillText(a.title,20, count * 100);
          c.fillText(a.brand,20, (count * 100) + (count *20));
          c.fillText(`가격 : ${a.price}`,20,(count * 100) + (count *40));
          c.fillText(`수량 : ${a.count}`,20,(count * 100) + (count *60));

        });

        
        c.fillText(`합계 : ${sum}`,20,780);
        c.fillText(`총  ${$('.final_price').html()}`,20,800);
        


      })     
      $('#receipt_close').on('click',function(){
        $('.modal1').removeClass('show-modal');
        $('.modal2').removeClass('show-modal');
      });

      console.log(cart)

    </script>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>